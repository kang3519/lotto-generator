<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>로또 번호 생성기 – v13 (성능 개선)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.5.0/kakao.min.js" defer onload="Kakao.init('13aaec94bd811a32bbb688c8b1a37ba2');"></script>
  <style>
    :root{--red:#e74c3c;--orange:#f39c12;--green:#27ae60;--blue:#2980b9;--purple:#8e44ad;--primary:#3498db}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,Helvetica,sans-serif;background:#f9fafb;display:flex;justify-content:center;padding:24px}
    .container{width:100%;max-width:820px;display:flex;flex-direction:column;gap:16px}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);padding:16px;width:100%}
    h1,h2,h3{text-align:center;margin:6px 0}
    .num{width:36px;height:36px;line-height:36px;border-radius:50%;margin:3px;color:#fff;text-align:center;font-weight:600;display:inline-block}
    .set{display:flex;justify-content:center;flex-wrap:wrap}
    .r1{background:var(--red)}.r2{background:var(--orange)}.r3{background:var(--green)}.r4{background:var(--blue)}.r5{background:var(--purple)}
    .btn{display:inline-flex;align-items:center;gap:6px;margin:6px 10px;padding:8px 22px;background:var(--primary);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:1rem}
    .btn:hover{background:#2378be}
    .btn-row{display:flex;justify-content:center;flex-wrap:wrap}
    .progress-bar{width:100%;height:12px;background:#eee;border-radius:6px;overflow:hidden;margin:8px 0}
    .progress-bar-inner{height:100%;background:var(--primary);width:0;transition:width .3s ease}
    .share-row{display:flex;justify-content:center;gap:14px;flex-wrap:wrap;margin-top:6px}
    .share-btn img{width:28px;height:28px}
    #error{color:var(--red);text-align:center;margin-top:6px}
    canvas{max-width:100%;height:auto}
  </style>
</head>
<body>
<div class="container">
  <section class="card" id="card-latest">
    <h1 style="background:linear-gradient(90deg,var(--red),var(--orange),var(--green),var(--blue),var(--purple));-webkit-background-clip:text;color:transparent;font-weight:700">로또 번호 생성기 🎉</h1>
    <h3 id="last-info">AI 패턴 분석 중...</h3>
    <div id="last-numbers" class="set"></div>
    <div class="progress-bar"><div class="progress-bar-inner"></div></div>
  </section>
  <section class="card"><h2>1등 패턴 근접 추천 3세트</h2><div id="pattern-reco"></div><small id="pattern-desc" style="display:block;text-align:center;color:#555"></small></section>
  <section class="card"><h2>일반 번호 2세트</h2><div id="random"></div><div class="btn-row"><button class="btn" id="btn-generate">새로운 번호 생성</button><button class="btn" id="btn-shot">📸 캡처 PNG</button></div></section>
  <section class="card"><h3>최근 100회 번호 출현 빈도</h3><canvas id="freqChart" height="240"></canvas></section>
  <section class="card"><h2>공유하기</h2><div class="share-row"><button class="btn share-btn" id="share-kakao"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/kakaotalk.svg" alt="kakao">카카오톡</button><button class="btn share-btn" id="share-twitter"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/x.svg" alt="twitter">X</button><button class="btn share-btn" id="share-copy"><img src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/icons/link.svg" alt="copy">링크 복사</button></div></section>
  <div id="error"></div>
</div>
<script>
/***** proxy with memo *****/
const PROXIES=[
  u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u=>`https://corsproxy.io/?${encodeURIComponent(u)}`,
  u=>`https://thingproxy.freeboard.io/fetch/${u}`
];
let bestProxyIdx=localStorage.bestProxyIdx?+localStorage.bestProxyIdx:null;
async function fetchJSON(url){
  // 배열 인덱스 제대로 추출
  const order=[
    ...(bestProxyIdx!==null?[bestProxyIdx]:[]),
    ...PROXIES.map((_,i)=>i)
  ].filter((v,i,a)=>a.indexOf(v)===i);
  for(const i of order){
    try{
      const json=await fetch(PROXIES[i](url)).then(r=>r.json());
      if(bestProxyIdx===null){bestProxyIdx=i;localStorage.bestProxyIdx=i;}
      return json;
    }catch{}
  }
  throw '모든 proxy 실패';
}
/***** utils *****/
const cls=n=>n<=10?'r1':n<=20?'r2':n<=30?'r3':n<=40?'r4':'r5';
const ball=n=>`<span class="num ${cls(n)}">${n}</span>`;
const setHTML=s=>`<div class="set">${s.map(ball).join('')}</div>`;
function render(el,sets){el.innerHTML=sets.map(setHTML).join('');}
function pick6(arr){
  // Fisher-Yates shuffle, 배열로 인자 받기
  const a=arr.slice();
  for(let i=a.length-1;i>0;--i){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a.slice(0,6).sort((x,y)=>x-y);
}
/***** globals *****/
let chart,history=[],avgStats={};
/***** fetch draws *****/
async function latestNo(){
  const base=Math.floor((Date.now()-Date.UTC(2002,11,7))/6048e5)+5;
  for(let n=base;n>base-60;--n){
    try{
      const d=await fetchJSON(`https://www.dhlottery.co.kr/common.do?method=getLottoNumber&drwNo=${n}`);
      if(d.returnValue==='success')return n;
    }catch{}
  }
  throw '최신 회차 실패';
}
/***** parallel fetch in chunks *****/
async function fetchRange(latest){
  const ids=[...Array(100)].map((_,i)=>latest-i);
  const chunk=10;
  const out=[];
  for(let i=0;i<ids.length;i+=chunk){
    const slice=ids.slice(i,i+chunk);
    const res=await Promise.allSettled(
      slice.map(n=>fetchJSON(`https://www.dhlottery.co.kr/common.do?method=getLottoNumber&drwNo=${n}`))
    );
    res.forEach(r=>out.push(r));
    document.querySelector('.progress-bar-inner').style.width=`${(out.length/100*100).toFixed(0)}%`;
  }
  return out.filter(r=>r.status==='fulfilled').map(r=>r.value);
}
/***** stats helpers *****/
const sOf=s=>{
  const sum=s.reduce((a,b)=>a+b,0);
  return {sum,odd:s.filter(n=>n%2).length,high:s.filter(n=>n>30).length};
};
const avg=a=>a.reduce((x,y)=>x+y,0)/a.length;
/***** main load *****/
async function load(){
  const e=document.getElementById('error');e.textContent='';
  try{
    const latest=await latestNo();
    const draws=await fetchRange(latest);
    history=draws.map(d=>[1,2,3,4,5,6].map(k=>d[`drwtNo${k}`]));
    document.getElementById('last-info').textContent=`최근 회차 ${latest} 번호`;
    document.getElementById('last-numbers').innerHTML=history[0].map(ball).join('');
    const stats=history.map(sOf);
    avgStats={
      sum:avg(stats.map(s=>s.sum)),
      odd:avg(stats.map(s=>s.odd)),
      high:avg(stats.map(s=>s.high))
    };
    document.getElementById('pattern-desc').textContent=
      `목표 ▸ 합계≈${avgStats.sum.toFixed(0)}, 홀≈${avgStats.odd.toFixed(1)}, 고수≈${avgStats.high.toFixed(1)}`;
    const freq={};
    history.flat().forEach(n=>freq[n]=(freq[n]||0)+1);
    // chart.js 갱신: labels, data, color 동시 변경
    const labels=Object.keys(freq).sort((a,b)=>+a-+b);
    const data=labels.map(n=>freq[n]);
    const colors=labels.map(n=>({r1:'#e74c3c',r2:'#f39c12',r3:'#27ae60',r4:'#2980b9',r5:'#8e44ad'}[cls(+n)]));
    if(!chart){
      chart=new Chart(document.getElementById('freqChart'),{
        type:'bar',
        data:{
          labels:labels,
          datasets:[{data:data,backgroundColor:colors}]
        },
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });
    }else{
      chart.data.labels=labels;
      chart.data.datasets[0].data=data;
      chart.data.datasets[0].backgroundColor=colors;
      chart.update();
    }
    generate();
  }catch(err){e.textContent=err;}
}
/***** pattern score & generate *****/
const score=s=>{
  const st=sOf(s);
  return Math.abs(st.sum-avgStats.sum)+Math.abs(st.odd-avgStats.odd)*8+Math.abs(st.high-avgStats.high)*6;
};
function generate(){
  if(!history.length){load();return;}
  const nums=[...Array(45)].map((_,i)=>i+1);
  const candidates=Array.from({length:3000},()=>pick6(nums));
  candidates.sort((a,b)=>score(a)-score(b));
  render(document.getElementById('pattern-reco'),candidates.slice(0,3));
  render(document.getElementById('random'),[
    pick6(nums),
    pick6(nums)
  ]);
  window.shareText=`${location.href.split('?')[0]}\n추천:${candidates.slice(0,3).map(s=>s.join(', ')).join(' | ')}\n일반:${document.getElementById('random').innerText}`;
}
/***** events *****/
window.addEventListener('DOMContentLoaded',load);
document.getElementById('btn-generate').onclick=generate;
document.getElementById('btn-shot').onclick=()=>html2canvas(document.querySelector('#pattern-reco')).then(c=>{
  const a=document.createElement('a');
  a.href=c.toDataURL();
  a.download='lotto.png';
  a.click();
});
const $=id=>document.getElementById(id);
$('share-copy').onclick=async()=>{
  await navigator.clipboard.writeText(window.shareText);
  alert('복사됨');
};
$('share-twitter').onclick=()=>window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(window.shareText)}`,'_blank');
$('share-kakao').onclick=()=>Kakao.Share.sendDefault({
  objectType:'text',
  text:window.shareText,
  link:{mobile_web_url:location.href,web_url:location.href}
});
</script>
</body>
</html>
