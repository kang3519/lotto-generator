async function fetchRange(latest){
  const ids=[...Array(100)].map((_,i)=>latest-i);
  const chunk=10, out=[];
  for(let i=0;i<ids.length;i+=chunk){
    const slice=ids.slice(i,i+chunk);
    const res=await Promise.allSettled(
      slice.map(n=>fetchJSON(`https://www.dhlottery.co.kr/common.do?method=getLottoNumber&drwNo=${n}`))
    );
    res.forEach(r=>out.push(r));
    document.querySelector('.progress-bar-inner').style.width=`${(out.length/100*100).toFixed(0)}%`;
  }
  // "6ê°œ ë²ˆí˜¸ë§Œ" ì •í™•ížˆ ìžˆëŠ” íšŒì°¨ë§Œ ë‚¨ê¹€
  return out
    .filter(r=>r.status==='fulfilled' && r.value && [1,2,3,4,5,6].every(k=>typeof r.value[`drwtNo${k}`]==='number'))
    .map(r=>[1,2,3,4,5,6].map(k=>r.value[`drwtNo${k}`]));
}

async function load(){
  const e=document.getElementById('error');e.textContent='';
  try{
    const latest=await latestNo();
    const draws=await fetchRange(latest);
    history=draws;
    document.getElementById('last-info').textContent=`ìµœê·¼ íšŒì°¨ ${latest} ë²ˆí˜¸`;
    document.getElementById('last-numbers').innerHTML=history[0].map(ball).join('');
    const stats=history.map(sOf);
    avgStats={
      sum:avg(stats.map(s=>s.sum)),
      odd:avg(stats.map(s=>s.odd)),
      high:avg(stats.map(s=>s.high))
    };
    document.getElementById('pattern-desc').textContent=
      `ëª©í‘œ â–¸ í•©ê³„â‰ˆ${avgStats.sum.toFixed(0)}, í™€â‰ˆ${avgStats.odd.toFixed(1)}, ê³ ìˆ˜â‰ˆ${avgStats.high.toFixed(1)}`;
    // ðŸ”¥ðŸ”¥ 1~45ë§Œ ë¹ˆë„ ëˆ„ì 
    const freq=Array(46).fill(0); // [0]~[45]
    for(const arr of history){
      for(const n of arr){
        if(Number.isInteger(n) && n>=1 && n<=45) freq[n]++;
      }
    }
    const labels=[...Array(45)].map((_,i)=>i+1);
    const data=labels.map(n=>freq[n]);
    const colors=labels.map(n=>({r1:'#e74c3c',r2:'#f39c12',r3:'#27ae60',r4:'#2980b9',r5:'#8e44ad'}[cls(n)]));
    if(!chart){
      chart=new Chart(document.getElementById('freqChart'),{
        type:'bar',
        data:{
          labels:labels,
          datasets:[{data:data,backgroundColor:colors}]
        },
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });
    }else{
      chart.data.labels=labels;
      chart.data.datasets[0].data=data;
      chart.data.datasets[0].backgroundColor=colors;
      chart.update();
    }
    generate();
  }catch(err){e.textContent=err;}
}
