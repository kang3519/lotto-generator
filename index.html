<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>로또 번호 생성기</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:Arial,sans-serif;background:#f9fafb;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0}
.container{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);width:100%;max-width:600px}
h1,h2,.last-draw{text-align:center;margin:12px 0}
.set{display:flex;justify-content:center;margin:8px 0;flex-wrap:wrap}
.num{width:36px;height:36px;line-height:36px;border-radius:50%;text-align:center;margin:4px;color:#fff;font-weight:bold}
.r1{background:#e74c3c}.r2{background:#f39c12}.r3{background:#27ae60}.r4{background:#2980b9}.r5{background:#8e44ad}
.btn{display:block;margin:20px auto 0;padding:10px 20px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:1em}
.btn:hover{background:#2980b9}
.error{text-align:center;color:#e74c3c;margin-top:10px}
.progress-bar{width:100%;background:#eee;border-radius:6px;overflow:hidden;margin:10px 0;height:14px}
.progress-bar-inner{height:100%;background:#3498db;width:0;transition:width 0.3s}
#chart-container{margin-top:20px}
</style>
</head>
<body>
<div class="container">
  <h1>로또 번호 생성기 🎉</h1>
  <div class="last-draw">로딩 중...</div>
  <div class="progress-bar"><div class="progress-bar-inner"></div></div>
  <div class="section-title">추천 번호 3세트</div>
  <div id="recommended"></div>
  <div class="section-title">일반 번호 2세트</div>
  <div id="random"></div>
  <button class="btn" onclick="generate()">번호 새로고침</button>
  <div id="chart-container"><canvas id="freqChart"></canvas></div>
  <div class="error" id="error"></div>
</div>
<script>
function colorClass(n){return n<=10?'r1':n<=20?'r2':n<=30?'r3':n<=40?'r4':'r5';}
function render(container, sets){
  container.innerHTML = '';
  sets.forEach(set => {
    const div = document.createElement('div');
    div.className = 'set';
    set.forEach(n => {
      const span = document.createElement('div');
      span.className = 'num ' + colorClass(n);
      span.textContent = n;
      div.appendChild(span);
    });
    container.appendChild(div);
  });
}
function pickNumbers(pool){
  const a=pool.slice(),p=[];
  while(p.length<6&&a.length)p.push(a.splice(Math.random()*a.length|0,1)[0]);
  return p.sort((x,y)=>x-y);
}
async function getLatestDraw(){
  let drwNo=1200;
  while(drwNo>0){
    const data=await fetch(`https://corsproxy.io/?https://www.dhlottery.co.kr/common.do?method=getLottoNumber&drwNo=${drwNo}`)
    .then(r=>r.text()).then(t=>JSON.parse(t)).catch(()=>null);
    if(data&&data.returnValue==='success') return data;
    drwNo--;
  }
  throw new Error('최신 회차를 찾지 못했습니다.');
}
async function generate(){
  try{
    document.getElementById('error').textContent = '';
    document.getElementById('recommended').innerHTML='';
    document.getElementById('random').innerHTML='';
    document.getElementById('freqChart').getContext('2d').clearRect(0,0,600,400);
    const latest = await getLatestDraw();
    const lastNums = Array.from({length:6}, (_,i)=>latest['drwtNo'+(i+1)]);
    document.querySelector('.last-draw').textContent = `지난 회차 (${latest.drwNo}) 번호: ${lastNums.join(', ')}`;
    const freq={}, bar=document.querySelector('.progress-bar-inner');
    for(let i=1;i<=latest.drwNo;i++){
      const h=await fetch(`https://corsproxy.io/?https://www.dhlottery.co.kr/common.do?method=getLottoNumber&drwNo=${i}`)
      .then(r=>r.text()).then(t=>JSON.parse(t)).catch(()=>null);
      if(h&&h.returnValue==='success'){
        for(let j=1;j<=6;j++){
          const n=h['drwtNo'+j];
          freq[n]=(freq[n]||0)+1;
        }
      }
      bar.style.width=`${(i/latest.drwNo*100).toFixed(1)}%`;
    }
    const pool=Object.keys(freq).sort((a,b)=>freq[b]-freq[a]).slice(0,40).map(Number);
    const recommendedSets=Array.from({length:3},()=>pickNumbers(pool));
    const randomSets=Array.from({length:2},()=>pickNumbers(Array.from({length:45},(_,i)=>i+1)));
    render(document.getElementById('recommended'),recommendedSets);
    render(document.getElementById('random'),randomSets);

    // Chart
    const ctx=document.getElementById('freqChart').getContext('2d');
    if(window.freqChart) window.freqChart.destroy();
    window.freqChart=new Chart(ctx,{
      type:'bar',
      data:{
        labels:Object.keys(freq),
        datasets:[{label:'출현 빈도',data:Object.values(freq),backgroundColor:'#3498db'}]
      },
      options:{scales:{y:{beginAtZero:true}}}
    });
  }catch(e){
    console.error(e);
    document.getElementById('error').textContent = '데이터를 불러오는 중 오류가 발생했습니다.';
  }
}
document.addEventListener('DOMContentLoaded',generate);
</script>
</body>
</html>
